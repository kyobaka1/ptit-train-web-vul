<main class="main has-sticky" role="main">
    <div class="content">
        <article id="post-fileupload/fileupload_fix" class="article article-type-post" itemscope="" itemtype="http://schema.org/BlogPosting">
            <div class="article-header">
                <h1 class="article-title" itemprop="name">
                    Phòng Chống Lỗ Hổng Upload File Trong PHP
                </h1>
                <div class="article-meta"><a href="?page=<?php echo $parent; ?>"><span>Back To Home</span></a>
               <?php if($src_youtube != ''){echo '<button id="introduce-btn"><img src="public/images/play-circle.png" class="img-circle img-rotate" style="height: 24px; width: 24px; margin-right: 5px" " />Hướng Dẫn</button>';} ?>
                </div>
            </div>
            <?php echo get_iframe_youtube($src_youtube); ?>
            <div class="article-entry marked-body" itemprop="articleBody">
                <p>Có khá là nhiều cách để phòng chống lổ hỗng trong file upload. Tuỳ theo phong cách và sở thích của nhà phát triển mà từng cách được áp dụng.</p>
                <h1 id="Rang-buoc-tat-ca"><a href="#Rang-buoc-tat-ca" class="headerlink" title="Ràng buộc tất cả"></a>Ràng buộc tất cả</h1>
                <p>Các thông tin người dùng có thể cung cấp như tên file, kiểu file, kể cả nội dung file đều không được tin tưởng.<br>Ta cần ràng buộc chúng, và không cho phép bất cứ trường hợp nào được thoát khỏi.</p>
                <h2 id="Vi-du"><a href="#Vi-du" class="headerlink" title="Ví dụ"></a>Ví dụ</h2>
                <p>Nếu cho upload file ảnh, ta cần chắc chắn extension của file là jpg, jpeg,png và gif. Loại file đúng image/jpeg, image/png, image/gif.<br>Nội dung của file ảnh,ta cần dùng các hàm có sẵn của PHP để tạo một file ảnh mới từ nội dung của file ảnh cũ như <strong>imagecreatefromjpeg()</strong></p>
                <h1 id="Ten-file-duoc-tao-ngau-nhien"><a href="#Ten-file-duoc-tao-ngau-nhien" class="headerlink" title="Tên file được tạo ngẫu nhiên"></a>Tên file được tạo ngẫu nhiên</h1>
                <p>Tên file tạo ra một cách ngẫu nhiên là một ý kiến hay có thể phòng chống lỗ hổng trong fileupload. Kẻ tấn công dù biết là file mã độc upload thành công đi chăng nữa thì cũng không biết đâu mà lần mà.</p>
                <p>Cần kết hợp với CSDL để lưu trữ tên file thật sự của người dùng tới tên file ngẫu nhiên được tạo trên server. Tất nhiên là phòng chống SQL Injection luôn nhé.</p>
                <h1 id="Dung-htaccess"><a href="#Dung-htaccess" class="headerlink" title="Dùng .htaccess"></a>Dùng .htaccess</h1>
                <p>Ta có thể dùng file <strong>.htaccess</strong> để cấu hình không cho phép file trong thư mục <strong>upload</strong> chạy như PHP. Vậy cứ để kẻ tấn công upload thoải mái, đến lúc hắn vui mừng thành công thì nhận ra,nó hoạt động như một file text. :))</p>
                <h1 id="Doan-code-upload-tham-khao-muc-do-imposssible-cua-DVWA"><a href="#Doan-code-upload-tham-khao-muc-do-imposssible-cua-DVWA" class="headerlink" title="Đoạn code upload tham khảo mức độ imposssible của DVWA"></a>Đoạn code upload tham khảo mức độ <strong>imposssible</strong> của DVWA</h1>
                <figure class="highlight php">
                    <table>
                        <tbody>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( $_POST[ <span class="string">'Upload'</span> ] ) ) {</span><br><span class="line">	<span class="comment">// Check Anti-CSRF token</span></span><br><span class="line">	checkToken( $_REQUEST[ <span class="string">'user_token'</span> ], $_SESSION[ <span class="string">'session_token'</span> ], <span class="string">'index.php'</span> );</span><br><span class="line"></span><br><span class="line">	<span class="comment">// File information</span></span><br><span class="line">	$uploaded_name = $_FILES[ <span class="string">'uploaded'</span> ][ <span class="string">'name'</span> ];</span><br><span class="line">	$uploaded_ext  = substr( $uploaded_name, strrpos( $uploaded_name, <span class="string">'.'</span> ) + <span class="number">1</span>);</span><br><span class="line">	$uploaded_size = $_FILES[ <span class="string">'uploaded'</span> ][ <span class="string">'size'</span> ];</span><br><span class="line">	$uploaded_type = $_FILES[ <span class="string">'uploaded'</span> ][ <span class="string">'type'</span> ];</span><br><span class="line">	$uploaded_tmp  = $_FILES[ <span class="string">'uploaded'</span> ][ <span class="string">'tmp_name'</span> ];</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Where are we going to be writing to?</span></span><br><span class="line">	$target_path   = DVWA_WEB_PAGE_TO_ROOT . <span class="string">'hackable/uploads/'</span>;</span><br><span class="line">	<span class="comment">//$target_file   = basename( $uploaded_name, '.' . $uploaded_ext ) . '-';</span></span><br><span class="line">	$target_file   =  md5( uniqid() . $uploaded_name ) . <span class="string">'.'</span> . $uploaded_ext;</span><br><span class="line">	$temp_file     = ( ( ini_get( <span class="string">'upload_tmp_dir'</span> ) == <span class="string">''</span> ) ? ( sys_get_temp_dir() ) : ( ini_get( <span class="string">'upload_tmp_dir'</span> ) ) );</span><br><span class="line">	$temp_file    .= DIRECTORY_SEPARATOR . md5( uniqid() . $uploaded_name ) . <span class="string">'.'</span> . $uploaded_ext;</span><br><span class="line">	<span class="comment">// Is it an image?</span></span><br><span class="line">	<span class="keyword">if</span>( ( strtolower( $uploaded_ext ) == <span class="string">'jpg'</span> || strtolower( $uploaded_ext ) == <span class="string">'jpeg'</span> || strtolower( $uploaded_ext ) == <span class="string">'png'</span> ) &amp;&amp;</span><br><span class="line">		( $uploaded_size &lt; <span class="number">100000</span> ) &amp;&amp;</span><br><span class="line">		( $uploaded_type == <span class="string">'image/jpeg'</span> || $uploaded_type == <span class="string">'image/png'</span> ) &amp;&amp;</span><br><span class="line">		getimagesize( $uploaded_tmp ) ) {</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Strip any metadata, by re-encoding image (Note, using php-Imagick is recommended over php-GD)</span></span><br><span class="line">		<span class="keyword">if</span>( $uploaded_type == <span class="string">'image/jpeg'</span> ) {</span><br><span class="line">			$img = imagecreatefromjpeg( $uploaded_tmp );</span><br><span class="line">			imagejpeg( $img, $temp_file, <span class="number">100</span>);</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">else</span> {</span><br><span class="line">			$img = imagecreatefrompng( $uploaded_tmp );</span><br><span class="line">			imagepng( $img, $temp_file, <span class="number">9</span>);</span><br><span class="line">		}</span><br><span class="line">		imagedestroy( $img );</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Can we move the file to the web root from the temp folder?</span></span><br><span class="line">		<span class="keyword">if</span>( rename( $temp_file, ( getcwd() . DIRECTORY_SEPARATOR . $target_path . $target_file ) ) ) {</span><br><span class="line">			<span class="comment">// Yes!</span></span><br><span class="line">			$html .= <span class="string">"&lt;pre&gt;&lt;a href='${target_path}${target_file}'&gt;${target_file}&lt;/a&gt; succesfully uploaded!&lt;/pre&gt;"</span>;</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">else</span> {</span><br><span class="line">			<span class="comment">// No</span></span><br><span class="line">			$html .= <span class="string">'&lt;pre&gt;Your image was not uploaded.&lt;/pre&gt;'</span>;</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Delete any temp files</span></span><br><span class="line">		<span class="keyword">if</span>( file_exists( $temp_file ) )</span><br><span class="line">			unlink( $temp_file );</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">else</span> {</span><br><span class="line">		<span class="comment">// Invalid file</span></span><br><span class="line">		$html .= <span class="string">'&lt;pre&gt;Your image was not uploaded. We can only accept JPEG or PNG images.&lt;/pre&gt;'</span>;</span><br><span class="line">	}</span><br><span class="line">}</span><br><span class="line"><span class="comment">// Generate Anti-CSRF token</span></span><br><span class="line">generateSessionToken();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </figure>
                <h1 id="Doan-code-upload-file-su-dung-ten-file-ngau-nhien"><a href="#Doan-code-upload-file-su-dung-ten-file-ngau-nhien" class="headerlink" title="Đoạn code upload file sử dụng tên file ngẫu nhiên"></a>Đoạn code upload file sử dụng tên file ngẫu nhiên</h1>
                <h2 id="Code-xu-ly-upload"><a href="#Code-xu-ly-upload" class="headerlink" title="Code xử lý upload"></a>Code xử lý upload</h2>
                <figure class="highlight php">
                    <table>
                        <tbody>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span> <span class="string">'DB.php'</span>; <span class="comment"># We are using PEAR::DB module</span></span><br><span class="line">$uploaddir = <span class="string">'/var/spool/uploads/'</span>; <span class="comment"># Outside of web root</span></span><br><span class="line">$uploadfile = tempnam($uploaddir, <span class="string">"upload_"</span>);</span><br><span class="line"><span class="keyword">if</span> (move_uploaded_file($_FILES[<span class="string">'userfile'</span>][<span class="string">'tmp_name'</span>], $uploadfile)) {</span><br><span class="line">    <span class="comment"># Saving information about this file in the DB</span></span><br><span class="line">    $db </span><br><span class="line">=&amp; </span><br><span class="line">DB::connect(<span class="string">"mysql://username:password@localhost/database"</span>);</span><br><span class="line">    <span class="keyword">if</span>(PEAR::isError($db)) {</span><br><span class="line">unlink(</span><br><span class="line">$uploadfile</span><br><span class="line">);</span><br><span class="line">       <span class="keyword">die</span> <span class="string">"Error connecting to the database"</span>;</span><br><span class="line">    }</span><br><span class="line">    $res = $db-&gt;query(<span class="string">"INSERT INTO uploads SET name=?, original_name=?,</span></span><br><span class="line"><span class="string">mime_type=?"</span>, </span><br><span class="line">          <span class="keyword">array</span>(basename($uploadfile, </span><br><span class="line">                         basename($_FILES[<span class="string">'userfile'</span>][<span class="string">'name'</span>]),    </span><br><span class="line">$_FILES[<span class="string">'userfile'</span>][<span class="string">'type'</span>]</span><br><span class="line">));</span><br><span class="line">    <span class="keyword">if</span>(PEAR::isError($res)) {</span><br><span class="line">          unlink(</span><br><span class="line">$uploadfile</span><br><span class="line">);</span><br><span class="line">          <span class="keyword">die</span> <span class="string">"Error saving data to the database. The file was not uploaded"</span>;</span><br><span class="line">    }</span><br><span class="line">    $id = $db-&gt;getOne(<span class="string">'SELECT LAST_INSERT_ID() FROM uploads'</span>); <span class="comment"># MySQL specific</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"File is valid, and was successfully uploaded. You can view it &lt;a</span></span><br><span class="line"><span class="string">href=\"view6.php?id=$id\"&gt;here&lt;/a&gt;\n"</span>;</span><br><span class="line">} <span class="keyword">else</span> {</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"File uploading failed.\n"</span>;</span><br><span class="line">}</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </figure>
                <h2 id="Code-xu-ly-view-file"><a href="#Code-xu-ly-view-file" class="headerlink" title="Code xử lý view file"></a>Code xử lý view file</h2>
                <figure class="highlight plain">
                    <table>
                        <tbody>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line">&lt;?php</span><br><span class="line">require_once 'DB.php';</span><br><span class="line">$uploaddir = '/var/spool/uploads/';</span><br><span class="line">$id = $_GET['id'];</span><br><span class="line">if(!is_numeric($id)) {</span><br><span class="line">   die("File id must be numeric");</span><br><span class="line">}</span><br><span class="line">$db =&amp; DB::connect("mysql://root@localhost/db");</span><br><span class="line">if(PEAR::isError($db)) {</span><br><span class="line">    die("Error connecting to the database");</span><br><span class="line">}</span><br><span class="line">$file = $db-&gt;getRow('SELECT name, mime_type FROM uploads WHERE id=?',</span><br><span class="line">array($id), DB_FETCHMODE_ASSOC);</span><br><span class="line">if(PEAR::isError($file)) {</span><br><span class="line">    die("Error fetching data from the database");</span><br><span class="line">}</span><br><span class="line">if(is_null($file) || count($file)==0) {</span><br><span class="line">    die("File not found");</span><br><span class="line">}</span><br><span class="line">header("Content-Type: " . $file['mime_type']);</span><br><span class="line">readfile($uploaddir.$file['name']);</span><br><span class="line">?&gt;</span><br></pre>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </figure>
            </div>
        </article>
        <?php
        if(isset($_GET['change_status'])){
            if($_GET['change_status'] == 1){
                change_status($id_post);
            }
        }
        echo print_footer_status($id_post,$title);
        ?>
        <section id="comments">
            <div id="vcomments"></div>
        </section>
    </div>

</main>